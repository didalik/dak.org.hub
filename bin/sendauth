#!/bin/bash

request () { # account {{{1
  local account=$1
  local email=$(git config --get user.email)
  local name=$(git config --get user.name)
  local hubpk="$(cat $HOME/.ssh/id_ed25519.pub)"
  local cmd="request $account $email $hubpk $name"
  #cmd='. $PWD/.ssh/.$HOSTNAME.env;PATH=$NODE_BIN:$PATH $SENDAUTH '"$cmd 2>/dev/null"
  cmd='. $PWD/.ssh/.$HOSTNAME.env;PATH=$NODE_BIN:$PATH $SENDAUTH '"$cmd"
  ssh $AUTH_ACCOUNT "$cmd" # TODO https://hx.didalik.workers.dev/sendauth/request
}

validate_args () { # authorization {{{1
  err "+ $0 started on $(date) with $# args: $@" >&2
  local auth=$1 account=$2
  case $auth in
    request)
      case $account in
        devhub|tophub) request $account;;
        *) return 2
      esac;;
    approval)
      validate_hub;;
    *) return 1
  esac
}

validate_hub () { # on approval {{{1
  local ifs="$IFS"
  IFS=".$IFS"
  read header payload64 signature
  IFS="$ifs"
  local payload="$(echo $payload64|base64 -d)"
  #echo -e "- header $header\n- payload $payload\n- signature $signature" >&2
  local hpk=${payload#*hpk?:?} asa=${payload#*asa?:?}
  hpk="${hpk%%?,*}"; asa="${asa%%?,*}"; out '+ validate_hub asa' $asa
  local hubpk="$(cat $HOME/.ssh/id_ed25519.pub)"
  if [ "$hpk" != "$hubpk" ]; then
    printc 'red bold' '+ validate_hub ERROR' hpk "'$hpk'" hubpk "'$hubpk'" >&2
    return 3;
  fi
  local cmd='approval'
  #cmd='. $PWD/.ssh/.$HOSTNAME.env;PATH=$NODE_BIN:$PATH $SENDAUTH '"$cmd 2>/dev/null"
  cmd='. $PWD/.ssh/.$HOSTNAME.env;PATH=$NODE_BIN:$PATH $SENDAUTH '"$cmd"
  echo "$header.$payload64.$signature" | ssh $asa "$cmd"
}

# }}}1

. lib/util.sh
. $HOME/.ssh/.$HOSTNAME.env

validate_args $@ || exit
